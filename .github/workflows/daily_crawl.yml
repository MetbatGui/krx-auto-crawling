name: Daily KRX Crawling

on:
  schedule:
    # Run at 15:59 KST (06:59 UTC) on weekdays
    - cron: '59 6 * * 1-5'
  workflow_dispatch:

jobs:
  crawl:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Just
      uses: extractions/setup-just@v2

    - name: Install uv
      uses: astral-sh/setup-uv@v3

    - name: Create secrets directory
      run: mkdir -p secrets

    - name: Create Secrets
      run: |
        echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}' > secrets/service_account.json
        chmod -R 777 secrets

    - name: Create .env file
      run: |
        echo "KRX_OTP_URL=http://data.krx.co.kr/comm/fileDn/GenerateOTP/generate.cmd" >> .env
        echo "KRX_DOWNLOAD_URL=http://data.krx.co.kr/comm/fileDn/download_csv/download.cmd" >> .env
        echo "GOOGLE_DRIVE_ROOT_FOLDER_ID=${{ secrets.GOOGLE_DRIVE_ROOT_FOLDER_ID }}" >> .env

    - name: Build Docker Image
      run: just -f Justfile.linux build

    - name: Run Healthcheck
      run: just -f Justfile.linux docker-healthcheck

    - name: Run Crawl (Drive Only)
      # GitHub Actions 환경에서는 로컬 저장이 의미가 없으므로 Drive Only 모드 사용
      run: just -f Justfile.linux crawl --drive
